<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory | Admin</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="nav">
    <a href="/dashboard.html">Dashboard</a>
    <a href="/products.html" class="nav-admin-only">Products</a>
    <a href="/orders.html" class="nav-admin-only">Orders</a>
    <a href="/inventory.html" class="active nav-admin-only">Inventory</a>
    <span class="spacer"></span>
    <button class="btn-logout" id="logoutBtn">Logout</button>
  </nav>

  <main class="container">
    <h1>Low Stock Products</h1>
    <p style="color:#94a3b8; margin-bottom: 1rem;">Products with stock <=5 </p>
    <div id="content" class="loading">Loading...</div>

    <h2 style="margin-top: 2rem; font-size: 1.2rem;">Bulk Restock</h2>
    <p style="color:#94a3b8; margin-bottom: 0.5rem;">Add quantity to products. Format: productId, quantity (one per line)</p>
    <div class="form-group">
      <textarea id="restockInput" rows="4" placeholder="64a1b2c3d4e5f6789012345, 10&#10;64a1b2c3d4e5f6789012346, 5" style="width:100%; max-width:400px; padding:0.5rem; background:#0f172a; border:1px solid #334155; border-radius:4px; color:#e2e8f0; font-family:monospace;"></textarea>
    </div>
    <button class="btn" id="restockBtn">Bulk Restock</button>
    <div class="error-msg" id="restockMsg"></div>
  </main>

  <script src="/js/api.js"></script>
  <script>
    (function() {
      if (!isLoggedIn()) { window.location.replace('/login.html'); return; }
      if (isAnalyst()) { window.location.replace('/dashboard.html'); return; }
      document.getElementById('logoutBtn').onclick = logout;

    async function loadLowStock() {
      const content = document.getElementById('content');
      try {
        const res = await getLowStock(5);
        const products = res.data || [];

        content.innerHTML = products.length === 0
          ? '<p style="color:#94a3b8">No low stock products.</p>'
          : `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Brand</th>
                  <th>Stock</th>
                  <th>Price</th>
                  <th>ID (for restock)</th>
                </tr>
              </thead>
              <tbody>
                ${products.map(p => `
                  <tr>
                    <td>${p.name}</td>
                    <td>${p.brand || '-'}</td>
                    <td><strong>${p.stock}</strong></td>
                    <td>$${p.price}</td>
                    <td><code style="font-size:0.8rem">${p._id}</code></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (err) {
        content.innerHTML = `<p class="error-msg">${err.message}</p>`;
      }
    }

    document.getElementById('restockBtn').onclick = async () => {
      const text = document.getElementById('restockInput').value.trim();
      const msg = document.getElementById('restockMsg');
      msg.textContent = '';

      if (!text) {
        msg.textContent = 'Enter productId,quantity pairs (one per line)';
        return;
      }

      const items = [];
      for (const line of text.split('\n')) {
        const [productId, quantity] = line.split(',').map(s => s.trim());
        if (productId && quantity) {
          items.push({ productId, quantity: parseInt(quantity) || 0 });
        }
      }

      if (items.length === 0) {
        msg.textContent = 'No valid items';
        return;
      }

      try {
        const res = await bulkRestock(items);
        msg.textContent = res.message || 'Restocked successfully';
        msg.style.color = '#4ade80';
        document.getElementById('restockInput').value = '';
        loadLowStock();
      } catch (e) {
        msg.textContent = e.message;
        msg.style.color = '#f87171';
      }
    };

      loadLowStock();
    })();
  </script>
</body>
</html>
